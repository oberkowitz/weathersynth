<!DOCTYPE html>
<html>
<head>
	<title></title>
	<script src="https://d3js.org/d3.v3.min.js"></script>
	<script src="https://d3js.org/d3-color.v1.min.js"></script>
	<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>

	<script type="text/javascript">
		window.onload = function(){ 
			var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
			var button = document.getElementById('b');
			var pre = document.querySelector('pre');
			var myScript = document.querySelector('script');

			var channels = 2;
			var frameCount = audioCtx.sampleRate * 2.0;

			var ardmap = function(x, inMin, inMax, outMin, outMax) {
				return (x - inMin) * (outMax - outMin) / (inMax - inMin) + outMin;
			}
			function pad(n, width, z) {
				z = z || '0';
				n = n + '';
				return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
			}
			
			function touch() {
				function randomDate(start, end) {
					return new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
				}
				var date = randomDate(new Date(2016, 0, 1), new Date(2016, 11, 31))

				d3.tsv("weatherData/KOAK/" + pad(date.getMonth()+1,2) + "-" + pad(date.getDate() + 1, 2) + "-16.tsv", function(data) {
					var temps = data.map(function(x) {
						var temp = +x["Temp."].replace(/[^\d.-]/g, '');
						return temp;
					});

					var normies = temps.map(function(x) {
						return ardmap(x, Math.min.apply(null, temps), Math.max.apply(null, temps), -1.0, 1.0);
					})

					var interp = d3.interpolateBasis(normies);
					var interped = d3.quantize(interp, 100);


					var myArrayBuffer = audioCtx.createBuffer(2, frameCount, audioCtx.sampleRate);

					for (var channel = 0; channel < channels; channel++) {
						var nowBuffering = myArrayBuffer.getChannelData(channel);
						for (var i = 0; i < frameCount; i++) {
							nowBuffering[i] = interped[i % interped.length] / 2.0;
						}
					}
					console.log("playing")

					var source = audioCtx.createBufferSource();
					source.buffer = myArrayBuffer;
					source.connect(audioCtx.destination);
					source.start();


				})

			}
			button.onclick = touch;
			console.log("ready");

		}
	</script>
</head>
<body>
	<pre></pre>
	<input type="button" id="b">Play the weather</input>
</body>
</html>
